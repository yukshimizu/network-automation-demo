# Ansible playbooks for building Arista EOS-based data center fabric
The goal behind the playbooks here is to demonstrate simple examples for automating Arista EOS-based network. The assumed network environment can be set up by the containerlab [here](../arista-clab/README.md).

## Included contents
### Roles
|Name     |Description|
|:--------|:----------|
|dc_fabric_config|A role to create device configurations.|
|provision_vlans|A role to create and configure VLANs/VXLAN.|

### Playbooks
|Name     |Role Used|Description|
|:--------|:--------|:----------|
|`pb_eos_enable_eapi.yml`|N/A|Enable eAPI on Arista devices.|
|`pb_arista_basic_config.yml`|N/A|Configure basic configurations and interfaces.|
|`pb_arista_dc_fabric.yml`|dc_fabric_config|Build Arista DC fabric configurations and deploy them on Arista devices.|
|`pb_arista_facts.yml`|N/A|Collect and validate Arista DC fabric Facts.|
|`pb_deploy_vlans.yml`|provision_vlans|Provision VLANs on Arista DC fabric.|
|`pb_get_vlans.yml`|N/A|Retrieve all VLANs and valiate them.|
|`pb_arista_backup.yml`|N/A|Backup Arista DC fabric configurations.|

## Prerequisites
### Basic requirements for Ansible
Any control node:
- ansible core 2.16+

Ansible collections:
- arista.eos

In order for functioning some playbooks, you need to install the following Python libraries.
```
$ pip3 install ansible-pylibssh netaddr
```

### Inventory
Each `ansible_host` in `inventory/ansible-inventory.yml` needs to match the corresponding containerlab, assuming that the ansible control node runs on the same host where the containerlab runs on.

## Usage
### Enable eAPI on Arista devices
The `ansible_connection` in `group_vars/arista.yml` needs to be set `network_cli` right after deploying the corresponding containerlab.  Otherwise, you must fail to connect via ssh to arista devices from ansible.
```
ansible_connection: network_cli 
```

The playbook `pb_eos_enable_eapi.yml` needs to be run at the beggining of demo.
```
$ ansible-playbook pb_eos_enable_eapi.yml
```

Then, you need to update the variable to `httpapi` after running the playbook.
```
# ansible_connection: network_cli 
ansible_connection: httpapi
```

### Configure generic system options and interfaces on Arista devices
There are two tags (`system` or `intf`) are attached to each tasks in `pb_arista_basic_config.yml`.

`system` tag instructs to configure dns and user (generic system options).
```
$ ansible-playbook pb_arista_basic_config.yml --tags system
```
`intf` tag instructs to configure interfaces.
```
$ ansible-playbook pb_arista_basic_config.yml --tags intf
```

### Configure and deploy all configurations on Arista devices
`pb_arista_dc_fabric.yml` builds the Arista DC fabric configuration files under `configs` directory and deploys them on the Arista devices. There are two tags (`build` or `deploy`) are attached to each tasks in the playbook. 

`build` tag instructs to build configuration files for each Arista devices. Those configuraton files are generated by using Jinja2 templates. Configurations are mainly related to underlay BGP and overlay BGP EVPN.
```
$ ansible-playbook pb_arista_dc_fabric.yml --tags build
```
`deploy` tag instructs to deploy the generated configurations on each Arista devices.
```
$ ansible-playbook pb_arista_dc_fabric.yml --tags deploy
```
Of course, you can execute together without `--tags` option.
```
$ ansible-playbook pb_arista_dc_fabric.yml
```

### Configure VLANs and VXLAN tunnels on Arista devices
Next, `pb_deploy_vlans.yml` configures VLANS on the DC fabric and then configures VXLAN tunnels using BGP EVPN. There are two tags (`vlans` or `vxlan`) are attached to each tasks in `provison_vlans` role which is imported by the playbook.

`vlans` tag instructs to configure VLANs on the DC fabric.
```
$ ansible-playbook pb_deploy_vlans.yml --tags vlans
```
`vxlan` tag instructs to congiure VXLAN tunnlels accross the DC fabric.
```
$ ansible-playbook pb_deploy_vlans.yml --tags vxlan
```

### Retrieve and valiate VLANs
`pb_get_vlans.yml` can retrive all VLANs information and valiate the state of them.
```
$ ansible-playbook pb_get_vlans.yml
```
Once deployed VLANs, you can validate by pinging servers each other.
```
$ docker exec -it clab-dc1-evpn-web01 bash
web01:/# ping 192.168.10.12  ! this is web02 in VLAN 10

$ docker exec -it clab-dc1-evpn-db01 bash
db01:/# ping 192.168.20.12  ! this is db02 in VLAN 20
```

### Collect Arista device facts
`pb_arista_facts.yml` can collect the basic facts from running Arista devices and provide a basic health check regarding the devices.
```
$ ansible-playbook pb_arista_facts.yml
```

### Backup the cnfigurations from Arista devices
`pb_arista_backup.yml` can backup the running configuration from the Arista devices to `backup` directory.
```
$ ansible-playbook pb_arista_backup.yml
```